version: '2.2'
services:
  es-redis:
    image: redis:5.0.7
    container_name: es-redis
    restart: always
    sysctls:
      - net.core.somaxconn=511
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /home/operation/data/redis:/data
      - /home/operation/app/elk-docker-compose/redis/redis.conf:/usr/local/etc/redis/redis.conf
    networks:
      elastic-network:
        ipv4_address: 172.18.0.12
    command: [ "redis-server", "/usr/local/etc/redis/redis.conf" ]
    labels:
      - "traefik.enable=true"
      - "traefik.tcp.routers.router-redis.rule=HostSNI(`*`)"
      - "traefik.tcp.routers.router-redis.entrypoints=entrypoint-redis"
      - "traefik.tcp.routers.router-redis.service=frontend-redis@docker"
      - "traefik.tcp.services.frontend-redis.loadbalancer.server.port=6379"
        
  es-mt01:
    build: ./elasticsearch
    image: custom-elasticsearch
    restart: always
    container_name: es-mt01
    environment:
      - network.host=0.0.0.0
      - node.name=es-mt01
      - node.master=true
      - node.data=false
      - node.ingest=false
      - cluster.remote.connect=false
      - cluster.name=nanoit-log-cluster
      - discovery.seed_hosts=es-mt02,es-mt03
      - cluster.initial_master_nodes=es-mt01,es-mt02,es-mt03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
      #- xpack.security.transport.ssl.enabled=true
      #- xpack.security.enabled=true
      - xpack.monitoring.enabled=true
      - xpack.monitoring.collection.enabled=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /home/operation/data/elasticsearch/master01/:/usr/share/elasticsearch/data
      - /home/operation/data/logs/elasticsearch/master01:/usr/share/elasticsearch/logs
      - ./elasticsearch/log4j2.properties:/usr/share/elasticsearch/config/log4j2.properties

      #- ./ssl/rootca.pem:/usr/share/elasticsearch/config/rootca.pem
      #- ./ssl/master01.pem:/usr/share/elasticsearch/config/master01.pem
      #- ./ssl/master01-key.pem:/usr/share/elasticsearch/config/master01-key.pem
      #- ./ssl/admin.pem:/usr/share/elasticsearch/config/admin.pem
      #- ./ssl/admin-key.pem:/usr/share/elasticsearch/config/admin-key.pem

      #- ./elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml

      #- ./elasticsearch/internal_users.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/internal_users.yml
      #- ./elasticsearch/roles_mapping.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles_mapping.yml
      #- ./elasticsearch/tenants.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/tenants.yml
      #- ./elasticsearch/roles.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles.yml
      #- ./elasticsearch/action_groups.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/action_groups.yml

    networks:
      elastic-network:
        ipv4_address: 172.18.0.2

  es-mt02:
    build: ./elasticsearch
    image: custom-elasticsearch
    restart: always
    container_name: es-mt02
    environment:
      - network.host=0.0.0.0
      - node.name=es-mt02
      - node.master=true
      - node.data=false
      - node.ingest=false
      - cluster.remote.connect=false
      - cluster.name=nanoit-log-cluster
      - discovery.seed_hosts=es-mt01,es-mt03
      - cluster.initial_master_nodes=es-mt01,es-mt02,es-mt03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
      #- xpack.security.transport.ssl.enabled=true
      #- xpack.security.enabled=true
      - xpack.monitoring.enabled=true
      - xpack.monitoring.collection.enabled=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /home/operation/data/elasticsearch/master02/:/usr/share/elasticsearch/data
      - /home/operation/data/logs/elasticsearch/master02:/usr/share/elasticsearch/logs
      - ./elasticsearch/log4j2.properties:/usr/share/elasticsearch/config/log4j2.properties

      #- ./ssl/rootca.pem:/usr/share/elasticsearch/config/rootca.pem
      #- ./ssl/master02.pem:/usr/share/elasticsearch/config/master02.pem
      #- ./ssl/master02-key.pem:/usr/share/elasticsearch/config/master02-key.pem
      #- ./ssl/admin.pem:/usr/share/elasticsearch/config/admin.pem
      #- ./ssl/admin-key.pem:/usr/share/elasticsearch/config/admin-key.pem

      #- ./elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml

      #- ./elasticsearch/internal_users.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/internal_users.yml
      #- ./elasticsearch/roles_mapping.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles_mapping.yml
      #- ./elasticsearch/tenants.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/tenants.yml
      #- ./elasticsearch/roles.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles.yml
      #- ./elasticsearch/action_groups.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/action_groups.yml
    networks:
      elastic-network:
        ipv4_address: 172.18.0.3

  es-mt03:
    build: ./elasticsearch
    image: custom-elasticsearch
    restart: always
    container_name: es-mt03
    environment:
      - network.host=0.0.0.0
      - node.name=es-mt03
      - node.master=true
      - node.data=false
      - node.ingest=false
      - cluster.remote.connect=false
      - cluster.name=nanoit-log-cluster
      - discovery.seed_hosts=es-mt01,es-mt02
      - cluster.initial_master_nodes=es-mt01,es-mt02,es-mt03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
      - xpack.monitoring.enabled=true
      - xpack.monitoring.collection.enabled=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /home/operation/data/elasticsearch/master03/:/usr/share/elasticsearch/data
      - /home/operation/data/logs/elasticsearch/master03:/usr/share/elasticsearch/logs
      - ./elasticsearch/log4j2.properties:/usr/share/elasticsearch/config/log4j2.properties

      #- ./ssl/rootca.pem:/usr/share/elasticsearch/config/rootca.pem
      #- ./ssl/master03.pem:/usr/share/elasticsearch/config/master03.pem
      #- ./ssl/master03-key.pem:/usr/share/elasticsearch/config/master03-key.pem
      #- ./ssl/admin.pem:/usr/share/elasticsearch/config/admin.pem
      #- ./ssl/admin-key.pem:/usr/share/elasticsearch/config/admin-key.pem

      #- ./elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml

      #- ./elasticsearch/internal_users.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/internal_users.yml
      #- ./elasticsearch/roles_mapping.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles_mapping.yml
      #- ./elasticsearch/tenants.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/tenants.yml
      #- ./elasticsearch/roles.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles.yml
      #- ./elasticsearch/action_groups.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/action_groups.yml
    networks:
      elastic-network:
        ipv4_address: 172.18.0.4

  es-cdn01:
    build: ./elasticsearch
    image: custom-elasticsearch
    restart: always
    container_name: es-cdn01
    environment:
      - network.host=0.0.0.0
      - node.name=es-cdn01
      - node.master=false
      - node.data=false
      - node.ingest=false
      - cluster.remote.connect=false
      - cluster.name=nanoit-log-cluster
      - discovery.seed_hosts=es-mt01,es-mt02,es-mt03
      - cluster.initial_master_nodes=es-mt01,es-mt02,es-mt03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
      - xpack.monitoring.enabled=true
      - xpack.monitoring.collection.enabled=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /home/operation/data/elasticsearch/coordinate01/:/usr/share/elasticsearch/data
      - /home/operation/data/logs/elasticsearch/coordinate01:/usr/share/elasticsearch/logs
      - ./elasticsearch/log4j2.properties:/usr/share/elasticsearch/config/log4j2.properties
       
      #- ./ssl/rootca.pem:/usr/share/elasticsearch/config/rootca.pem
      #- ./ssl/cdn01.pem:/usr/share/elasticsearch/config/cdn01.pem
      #- ./ssl/cdn01-key.pem:/usr/share/elasticsearch/config/cdn01-key.pem
      #- ./ssl/admin.pem:/usr/share/elasticsearch/config/admin.pem
      #- ./ssl/admin-key.pem:/usr/share/elasticsearch/config/admin-key.pem

      #- ./elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml

      #- ./elasticsearch/internal_users.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/internal_users.yml
      #- ./elasticsearch/roles_mapping.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles_mapping.yml
      #- ./elasticsearch/tenants.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/tenants.yml
      #- ./elasticsearch/roles.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles.yml
      #- ./elasticsearch/action_groups.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/action_groups.yml
    networks:
      elastic-network:
        ipv4_address: 172.18.0.5

  es-cdn02:
    build: ./elasticsearch
    image: custom-elasticsearch
    restart: always
    container_name: es-cdn02
    environment:
      - network.host=0.0.0.0
      - node.name=es-cdn02
      - node.master=false
      - node.data=false
      - node.ingest=false
      - cluster.remote.connect=false
      - cluster.name=nanoit-log-cluster
      - discovery.seed_hosts=es-mt01,es-mt02,es-mt03
      - cluster.initial_master_nodes=es-mt01,es-mt02,es-mt03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
      - xpack.monitoring.enabled=true
      - xpack.monitoring.collection.enabled=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /home/operation/data/elasticsearch/coordinate02/:/usr/share/elasticsearch/data
      - /home/operation/data/logs/elasticsearch/coordinate02:/usr/share/elasticsearch/logs
      - ./elasticsearch/log4j2.properties:/usr/share/elasticsearch/config/log4j2.properties

      #- ./ssl/rootca.pem:/usr/share/elasticsearch/config/rootca.pem
      #- ./ssl/cdn02.pem:/usr/share/elasticsearch/config/cdn02.pem
      #- ./ssl/cdn02-key.pem:/usr/share/elasticsearch/config/cdn02-key.pem
      #- ./ssl/admin.pem:/usr/share/elasticsearch/config/admin.pem
      #- ./ssl/admin-key.pem:/usr/share/elasticsearch/config/admin-key.pem

      #- ./elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml

      #- ./elasticsearch/internal_users.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/internal_users.yml
      #- ./elasticsearch/roles_mapping.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles_mapping.yml
      #- ./elasticsearch/tenants.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/tenants.yml
      #- ./elasticsearch/roles.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles.yml
      #- ./elasticsearch/action_groups.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/action_groups.yml
    networks:
      elastic-network:
        ipv4_address: 172.18.0.6

  es-data01:
    build: ./elasticsearch
    image: custom-elasticsearch
    restart: always
    container_name: es-data01
    environment:
      - network.host=0.0.0.0
      - node.name=es-data01
      - node.master=false
      - node.data=true
      - node.ingest=false
      - cluster.remote.connect=false
      - cluster.name=nanoit-log-cluster
      - discovery.seed_hosts=es-mt01,es-mt02,es-mt03
      - cluster.initial_master_nodes=es-mt01,es-mt02,es-mt03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
      - xpack.monitoring.enabled=true
      - xpack.monitoring.collection.enabled=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /home/operation/data/elasticsearch/data01/:/usr/share/elasticsearch/data
      - /home/operation/data/logs/elasticsearch/data01:/usr/share/elasticsearch/logs
      - ./elasticsearch/log4j2.properties:/usr/share/elasticsearch/config/log4j2.properties

      #- ./ssl/rootca.pem:/usr/share/elasticsearch/config/rootca.pem
      #- ./ssl/data01.pem:/usr/share/elasticsearch/config/data01.pem
      #- ./ssl/data01-key.pem:/usr/share/elasticsearch/config/data01-key.pem
      #- ./ssl/admin.pem:/usr/share/elasticsearch/config/admin.pem
      #- ./ssl/admin-key.pem:/usr/share/elasticsearch/config/admin-key.pem

      #- ./elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml

      #- ./elasticsearch/internal_users.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/internal_users.yml
      #- ./elasticsearch/roles_mapping.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles_mapping.yml
      #- ./elasticsearch/tenants.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/tenants.yml
      #- ./elasticsearch/roles.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles.yml
      #- ./elasticsearch/action_groups.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/action_groups.yml
    networks:
      elastic-network:
        ipv4_address: 172.18.0.7

  es-data02:
    build: ./elasticsearch
    image: custom-elasticsearch
    restart: always
    container_name: es-data02
    environment:
      - network.host=0.0.0.0
      - node.name=es-data02
      - node.master=false
      - node.data=true
      - node.ingest=false
      - cluster.remote.connect=false
      - cluster.name=nanoit-log-cluster
      - discovery.seed_hosts=es-mt01,es-mt02,es-mt03
      - cluster.initial_master_nodes=es-mt01,es-mt02,es-mt03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
      - xpack.monitoring.enabled=true
      - xpack.monitoring.collection.enabled=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /home/operation/data/elasticsearch/data02/:/usr/share/elasticsearch/data
      - /home/operation/data/logs/elasticsearch/data02:/usr/share/elasticsearch/logs
      - ./elasticsearch/log4j2.properties:/usr/share/elasticsearch/config/log4j2.properties

      #- ./ssl/rootca.pem:/usr/share/elasticsearch/config/rootca.pem
      #- ./ssl/data02.pem:/usr/share/elasticsearch/config/data02.pem
      #- ./ssl/data02-key.pem:/usr/share/elasticsearch/config/data02-key.pem
      #- ./ssl/admin.pem:/usr/share/elasticsearch/config/admin.pem
      #- ./ssl/admin-key.pem:/usr/share/elasticsearch/config/admin-key.pem

      #- ./elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml

      #- ./elasticsearch/internal_users.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/internal_users.yml
      #- ./elasticsearch/roles_mapping.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles_mapping.yml
      #- ./elasticsearch/tenants.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/tenants.yml
      #- ./elasticsearch/roles.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles.yml
      #- ./elasticsearch/action_groups.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/action_groups.yml
    networks:
      elastic-network:
        ipv4_address: 172.18.0.8

  es-data03:
    build: ./elasticsearch
    image: custom-elasticsearch
    restart: always
    container_name: es-data03
    environment:
      - network.host=0.0.0.0
      - node.name=es-data03
      - node.master=false
      - node.data=true
      - node.ingest=false
      - cluster.remote.connect=false
      - cluster.name=nanoit-log-cluster
      - discovery.seed_hosts=es-mt01,es-mt02,es-mt03
      - cluster.initial_master_nodes=es-mt01,es-mt02,es-mt03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
      - xpack.monitoring.enabled=true
      - xpack.monitoring.collection.enabled=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /home/operation/data/elasticsearch/data03/:/usr/share/elasticsearch/data
      - /home/operation/data/logs/elasticsearch/data03:/usr/share/elasticsearch/logs
      - ./elasticsearch/log4j2.properties:/usr/share/elasticsearch/config/log4j2.properties

      #- ./ssl/rootca.pem:/usr/share/elasticsearch/config/rootca.pem
      #- ./ssl/data03.pem:/usr/share/elasticsearch/config/data03.pem
      #- ./ssl/data03-key.pem:/usr/share/elasticsearch/config/data03-key.pem
      #- ./ssl/admin.pem:/usr/share/elasticsearch/config/admin.pem
      #- ./ssl/admin-key.pem:/usr/share/elasticsearch/config/admin-key.pem

      #- ./elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml

      #- ./elasticsearch/internal_users.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/internal_users.yml
      #- ./elasticsearch/roles_mapping.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles_mapping.yml
      #- ./elasticsearch/tenants.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/tenants.yml
      #- ./elasticsearch/roles.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles.yml
      #- ./elasticsearch/action_groups.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/action_groups.yml
    networks:
      elastic-network:
        ipv4_address: 172.18.0.15

  es-ing01:
    build: ./elasticsearch
    image: custom-elasticsearch
    container_name: es-ing01
    restart: always
    environment:
      - network.host=0.0.0.0
      - node.name=es-ing01
      - node.master=false
      - node.data=false
      - node.ingest=true
      - cluster.remote.connect=false
      - cluster.name=nanoit-log-cluster
      - discovery.seed_hosts=es-mt01,es-mt02,es-mt03
      - cluster.initial_master_nodes=es-mt01,es-mt02,es-mt03
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
      - xpack.monitoring.enabled=true
      - xpack.monitoring.collection.enabled=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /home/operation/data/elasticsearch/ingest01/:/usr/share/elasticsearch/data
      - /home/operation/data/logs/elasticsearch/ingest01:/usr/share/elasticsearch/logs
      - ./elasticsearch/log4j2.properties:/usr/share/elasticsearch/config/log4j2.properties

      #- ./ssl/rootca.pem:/usr/share/elasticsearch/config/rootca.pem
      #- ./ssl/ing01.pem:/usr/share/elasticsearch/config/ing01.pem
      #- ./ssl/ing01-key.pem:/usr/share/elasticsearch/config/ing01-key.pem
      #- ./ssl/admin.pem:/usr/share/elasticsearch/config/admin.pem
      #- ./ssl/admin-key.pem:/usr/share/elasticsearch/config/admin-key.pem

      #- ./elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml

      #- ./elasticsearch/internal_users.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/internal_users.yml
      #- ./elasticsearch/roles_mapping.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles_mapping.yml
      #- ./elasticsearch/tenants.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/tenants.yml
      #- ./elasticsearch/roles.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/roles.yml
      #- ./elasticsearch/action_groups.yml:/usr/share/elasticsearch/plugins/opendistro_security/securityconfig/action_groups.yml
    networks:
      elastic-network:
        ipv4_address: 172.18.0.14

  es-kib:
    build: ./kibana
    image: custom-kibana
    container_name: es-kib
    restart: always
    networks:
      elastic-network:
        ipv4_address: 172.18.0.9
    depends_on: ['es-mt01', 'es-mt02', 'es-mt03', 'es-cdn01', 'es-cdn02', 'es-data01', 'es-data02', 'es-data03']
    environment:
      #ELASTICSEARCH_HOSTS: '["http://es-mt01:9200","https://es-mt02:9200","https://es-mt03:9200","https://es-cdn01:9200","http://es-cdn02:9200","https://es-data01:9200","https://es-data02:9200","https://es-data03:9200","https://es-ing01:9200"]'
      #ELASTICSEARCH_URL: http://172.18.0.2:9200
      #ELASTICSEARCH_HOSTS: http://172.18.0.2:9200
      #SERVER_BASEPATH: /kibana
      #SERVER_REWRITEBASEPATH: "true"
      NODE_OPTIONS: "--max-old-space-size=2048"
      #SERVER_SSL_ENABLED: "true"
      #SERVER_SSL_VERIFICATIONMODE: certificate
      #SERVER_SSL_KEY: /usr/share/kibana/config/kib01-key.pem
      #SERVER_SSL_CERTIFICATE: /usr/share/kibana/config/kib01.pem
      #SERVER_SSL_CERTIFICATEAUTHORITIES: /usr/share/kibana/config/rootca.pem
      #SERVER_NAME: "es-kib"
      #SERVER_HOST: _site_
      #SERVER_PORT: "5601"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /home/operation/data/logs/elasticsearch/kibana01:/usr/share/kibana/log
      - /home/operation/data/htpasswd/userfile:/userfile
      - ./kibana/kibana.yml:/usr/share/kibana/config/kibana.yml
      #- ./ssl/rootca.pem:/usr/share/kibana/config/rootca.pem
      #- ./ssl/kib01.pem:/usr/share/kibana/config/kib01.pem
      #- ./ssl/kib01-key.pem:/usr/share/kibana/config/kib01-key.pem
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=elastic-network"
      - "traefik.http.services.dashboard-kibana.loadbalancer.server.port=5601"

      #- "traefik.http.routers.secured-kibana.rule=Host(`monitor.nanoit.kr`) && (PathPrefix(`/kibana`) || PathPrefix(`/kibana/`))"
      #- "traefik.http.routers.router-cerebro.rule=Host(`monitor.nanoit.kr`) && (PathPrefix(`/cerebro`) || PathPrefix(`/cerebro/`))"
      - "traefik.http.routers.secured-kibana.rule=Host(`monitor.nanoit.kr`)"
      - "traefik.http.routers.secured-kibana.entrypoints=entrypoint-https"
      - "traefik.http.routers.secured-kibana.service=dashboard-kibana@docker"
      - "traefik.http.routers.secured-kibana.tls=true"
      - "traefik.http.routers.secured-kibana.tls.certresolver=nanoit-cert"
      - "traefik.http.routers.secured-kibana.middlewares=basicauth@docker"
      - "traefik.http.middlewares.basicauth.basicauth.usersfile=/userfile"
   
  es-idx:
    image: docker.elastic.co/logstash/logstash:7.3.2
    container_name: es-idx
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./logstash/config/:/usr/share/logstash/config/
      - /home/operation/data/elasticsearch/logstash-idx01:/usr/share/logstash/data
      - /home/operation/data/logs/elasticsearch/logstash01:/usr/share/logstash/logs
    environment:
      LS_JAVA_OPTS: "-Xmx1024m -Xms1024m"
    networks:
      elastic-network:
        ipv4_address: 172.18.0.10
    restart: always
    depends_on: ['es-mt01', 'es-mt02', 'es-mt03', 'es-cdn01', 'es-cdn02', 'es-data01', 'es-data02', 'es-data03', 'es-kib']
    labels:
      - "traefik.enable=true"
      - "traefik.tcp.routers.router-logstash.rule=HostSNI(`*`)"
      - "traefik.tcp.routers.router-logstash.entrypoints=entrypoint-redis"
      - "traefik.tcp.routers.router-logstash.service=frontend-redis@docker"
      - "traefik.tcp.services.frontend-logstash.loadbalancer.server.port=5044"

  es-mtb:
    image: docker.elastic.co/beats/metricbeat:7.3.2
    container_name: es-mtb
    command: ["--strict.perms=false"]
    user: root
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /proc:/hostfs/proc:ro
      - /sys/fs/cgroup:/hostfs/sys/fs/cgroup:ro
      - /:/hostfs:ro
      - /home/operation/data/logs/elasticsearch/metricbeat01:/usr/share/metricbeat/logs
      - /home/operation/data/elasticsearch/metricbeat01/:/usr/share/metricbeat/data
      - /home/operation/app/elk-docker-compose/metricbeat/metricbeat.yml:/usr/share/metricbeat/metricbeat.yml
    network_mode: host
    restart: always
    depends_on: ['es-mt01', 'es-mt02', 'es-mt03', 'es-cdn01', 'es-cdn02', 'es-data01', 'es-data02', 'es-kib', 'es-idx', 'es-data03']
    cap_add:
      - sys_ptrace
      - dac_read_search

  es-htb:
    image: docker.elastic.co/beats/heartbeat:7.3.2
    container_name: es-htb
    command: ["--strict.perms=false"]
    user: root
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ./heartbeat/heartbeat.yml:/usr/share/heartbeat/heartbeat.yml
      - /home/operation/data/elasticsearch/heartbeat01/:/usr/share/heartbeat/data
      - /home/operation/data/logs/elasticsearch/heartbeat01:/usr/share/heartbeat/logs
    network_mode: host
    #networks:
    #- elastic-network
    restart: always
    depends_on: ['es-mt01', 'es-mt02', 'es-mt03', 'es-cdn01', 'es-cdn02', 'es-data01', 'es-data02', 'es-kib', 'es-idx', 'es-data03']

  es-ftb:
    image: docker.elastic.co/beats/filebeat:7.3.2
    container_name: es-ftb
    command: ["--strict.perms=false"]
    user: root
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/log:/usr/share/filebeat/logs/system

      - ./filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml
      - /home/operation/data/elasticsearch/filebeat01/:/usr/share/filebeat/data

      - /home/operation/data/logs/elasticsearch:/usr/share/filebeat/logs/elasticsearch
      - /home/operation/data/logs/traefik:/usr/share/filebeat/logs/traefik
      - /home/operation/data/redis/redis.log:/usr/share/filebeat/logs/redis/redis.log
    network_mode: host
    #networks:
      #- elastic-network
    restart: always
    depends_on: ['es-mt01', 'es-mt02', 'es-mt03', 'es-cdn01', 'es-cdn02', 'es-data01', 'es-data02', 'es-kib', 'es-idx', 'es-data03', 'es-redis']

  #es-ptb:
    #image: docker.elastic.co/beats/packetbeat:7.3.2
    #container_name: es-ptb
    #command: ["--strict.perms=false"]
    #user: root
    #volumes:
      #- /etc/localtime:/etc/localtime:ro
      #- /var/run/docker.sock:/var/run/docker.sock:ro

      #- /home/operation/data/elasticsearch/packetbeat01/:/usr/share/packetbeat/data
      #- /home/operation/data/logs/elasticsearch/packetbeat01:/usr/share/packetbeat/logs

      #- ./packetbeat/packetbeat.yml:/usr/share/packetbeat/packetbeat.yml
    #network_mode: host
    #restart: always
    #depends_on: ['es-mt01', 'es-mt02', 'es-mt03', 'es-cdn01', 'es-cdn02', 'es-data01', 'es-data02', 'es-kib', 'es-idx', 'es-data03']
    #cap_add:
      #- NET_RAW
      #- NET_ADMIN

networks:
  elastic-network:
    external: true
